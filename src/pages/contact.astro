---
// コンポーネント
import Layout from '../layouts/Layout.astro';

const title = "お問い合わせ・会員登録";
const description = "広島県小児科医会のお問い合わせ・会員登録のページです。お気軽にお問い合わせください";
const url = "https://blog.hiroshima-ped.com/contact";
const keyword = "お問い合わせ, 会員登録, 入局, 広島, 小児科医会, 広島県, 広島県小児科医会";

// 環境変数からサイトキーを取得
const siteKey = import.meta.env.RECAPTCHA_SITE_KEY;
---

<Layout title={title} description={description} url={url}>
	<div class="c-subpage__upper">
		<div class="c-subpage__upper-ttl">
			Contact
		</div>
		<div class="c-subpage__upper-pagination">
			<span><a href="/">トップ</a></span>
			<span></span>
			<span>お問い合わせ・会員登録</span>
		</div>
	</div>
	<section class="l-subpage">
		<h1 class="c-subpage__ttl u-font--32">
			お問い合わせ・会員登録
		</h1>
		<div class="c-subpage__subtext u-font--20">
			<p>
				入会・変更・退会、その他のお問合せはこちらから。
			</p>
		</div>
		<div class="c-contact__wrap">
			<form id="contactForm" class="c-contact" action="/api/contact" method="post" autocomplete="off">
				<!-- reCAPTCHA -->
				<input type="hidden" name="g-recaptcha-response" id="g-recaptcha-response" />
				
				<div class="c-contact__item">
					<label class="c-contact__item-label">
						<span>医籍番号(下4桁)</span>
						<span class="c-contact__item-label-necessary">必須</span>
					</label>
					<input id="id_number" class="c-contact__item-input" type="text" name="id_number" required maxlength="4" pattern="[0-9]{4}" placeholder="例:1234">
					<div id="error-id_number" class="c-contact__item-error"></div>
				</div>
				
				<div class="c-contact__item">
					<label class="c-contact__item-label">
						<span>お名前</span>
						<span class="c-contact__item-label-necessary">必須</span>
					</label>
					<input id="name" class="c-contact__item-input" type="text" name="name" required placeholder="例:小児科 太郎">
					<div id="error-name" class="c-contact__item-error"></div>
				</div>
				
				<div class="c-contact__item">
					<label class="c-contact__item-label">
						<span>生年月日</span>
						<span class="c-contact__item-label-necessary">必須</span>
					</label>
					<div class="c-contact__item-birthday">
						<span><input id="birth_year" class="c-contact__item-input" type="number" name="birth_year" required min="1900" max="2025" placeholder="1990">年</span>
						<span><input id="birth_month" class="c-contact__item-input" type="number" name="birth_month" required min="1" max="12" placeholder="1">月</span>
						<span><input id="birth_day" class="c-contact__item-input" type="number" name="birth_day" required min="1" max="31" placeholder="1">日</span>
					</div>
					<div id="error-birthday" class="c-contact__item-error"></div>
				</div>
				
				<div class="c-contact__item">
					<label class="c-contact__item-label">
						<span>メールアドレス</span>
						<span class="c-contact__item-label-necessary">必須</span>
					</label>
					<input id="email" class="c-contact__item-input" type="email" name="email" required placeholder="例:pediatric@example.com">
					<div id="error-email" class="c-contact__item-error"></div>
				</div>
				
				<div class="c-contact__item">
					<label class="c-contact__item-label">
						<span>お問合せ種別</span>
						<span class="c-contact__item-label-necessary">必須</span>
					</label>
					<div class="c-contact__item-radio-wrap">
						<input type="radio" name="type" value="入会申込" required checked id="apply">
						<label for="apply" class="c-contact__item-radio">入会申込</label>
						<input type="radio" name="type" value="登録内容変更" id="change">
						<label for="change" class="c-contact__item-radio">登録内容変更</label>
						<input type="radio" name="type" value="退会申込" id="leave">
						<label for="leave" class="c-contact__item-radio">退会申込</label>
						<input type="radio" name="type" value="その他" id="other">
						<label for="other" class="c-contact__item-radio">その他</label>
					</div>
				</div>
				
				<div class="c-contact__item">
					<label class="c-contact__item-label">
						<span>お問合せ内容</span>
						<span class="c-contact__item-label-any">任意</span>
					</label>
					<textarea class="c-contact__item-textarea" name="message" rows="5"></textarea>
				</div>
				
				<button type="submit" class="c-contact__submit">
					この内容で送信する<span class="c-contact__submit-arrow"></span>
				</button>
			</form>
		</div>
	</section>

	<!-- エラーメッセージのスタイル -->
	<style>
		.c-contact__item-error {
			display: none;
			color: #d32f2f;
			font-size: 14px;
			margin-top: 4px;
			padding-left: 4px;
		}
		
		.c-contact__item-input.error {
			border-color: #d32f2f;
		}
	</style>

	<!-- 統合されたフォーム処理 -->
	<script is:inline define:vars={{ siteKey }}>
		document.addEventListener("DOMContentLoaded", () => {
			let recaptchaReady = false;
			const form = document.getElementById("contactForm");
			
			console.log('Form initialized');
			console.log('siteKey:', siteKey ? 'exists' : 'missing');
			
			// エラーメッセージを表示する関数
			function showError(fieldId, message) {
				const errorElement = document.getElementById(`error-${fieldId}`);
				const inputElement = document.getElementById(fieldId);
				if (errorElement && inputElement) {
					errorElement.textContent = message;
					errorElement.style.display = "block";
					inputElement.classList.add("error");
				}
			}
			
			// エラーメッセージをクリアする関数
			function clearError(fieldId) {
				const errorElement = document.getElementById(`error-${fieldId}`);
				const inputElement = document.getElementById(fieldId);
				if (errorElement && inputElement) {
					errorElement.textContent = "";
					errorElement.style.display = "none";
					inputElement.classList.remove("error");
				}
			}
			
			// 生年月日のバリデーション
			function validateBirthday() {
				const birthYear = document.getElementById("birth_year");
				const birthMonth = document.getElementById("birth_month");
				const birthDay = document.getElementById("birth_day");
				const errorElement = document.getElementById("error-birthday");
				
				if (errorElement) {
					errorElement.textContent = "";
					errorElement.style.display = "none";
				}
				if (birthYear) birthYear.classList.remove("error");
				if (birthMonth) birthMonth.classList.remove("error");
				if (birthDay) birthDay.classList.remove("error");
				
				const year = parseInt(birthYear?.value);
				const month = parseInt(birthMonth?.value);
				const day = parseInt(birthDay?.value);
				
				if (!year || !month || !day) return false;
				
				if (year < 1900 || year > 2025) {
					if (errorElement && birthYear) {
						errorElement.textContent = "正しい年を入力してください(1900-2025)";
						errorElement.style.display = "block";
						birthYear.classList.add("error");
					}
					return false;
				}
				
				if (month < 1 || month > 12) {
					if (errorElement && birthMonth) {
						errorElement.textContent = "月は1〜12の範囲で入力してください";
						errorElement.style.display = "block";
						birthMonth.classList.add("error");
					}
					return false;
				}
				
				const daysInMonth = new Date(year, month, 0).getDate();
				if (day < 1 || day > daysInMonth) {
					if (errorElement && birthDay) {
						errorElement.textContent = `${month}月は1〜${daysInMonth}日の範囲で入力してください`;
						errorElement.style.display = "block";
						birthDay.classList.add("error");
					}
					return false;
				}
				
				const inputDate = new Date(year, month - 1, day);
				const today = new Date();
				if (inputDate > today) {
					if (errorElement) {
						errorElement.textContent = "未来の日付は入力できません";
						errorElement.style.display = "block";
						if (birthYear) birthYear.classList.add("error");
						if (birthMonth) birthMonth.classList.add("error");
						if (birthDay) birthDay.classList.add("error");
					}
					return false;
				}
				
				return true;
			}
			
			// 医籍番号のバリデーション
			const idNumberInput = document.getElementById("id_number");
			if (idNumberInput) {
				idNumberInput.addEventListener("input", (e) => {
					const value = e.target.value;
					clearError("id_number");
					e.target.value = value.replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
					
					if (value && !/^[0-9]*$/.test(value)) {
						showError("id_number", "半角数字で入力してください");
					} else if (value && value.length !== 4) {
						showError("id_number", "4桁で入力してください");
					}
				});
			}
			
			// お名前のバリデーション
			const nameInput = document.getElementById("name");
			if (nameInput) {
				nameInput.addEventListener("blur", (e) => {
					const value = e.target.value.trim();
					clearError("name");
					if (!value) {
						showError("name", "お名前を入力してください");
					}
				});
			}
			
			// 生年月日の各フィールドにイベントリスナー
			const birthYear = document.getElementById("birth_year");
			const birthMonth = document.getElementById("birth_month");
			const birthDay = document.getElementById("birth_day");
			if (birthYear) birthYear.addEventListener("blur", validateBirthday);
			if (birthMonth) birthMonth.addEventListener("blur", validateBirthday);
			if (birthDay) birthDay.addEventListener("blur", validateBirthday);
			
			// メールアドレスのバリデーション
			const emailInput = document.getElementById("email");
			if (emailInput) {
				emailInput.addEventListener("blur", (e) => {
					const value = e.target.value.trim();
					clearError("email");
					
					if (!value) {
						showError("email", "メールアドレスを入力してください");
						return;
					}
					
					if (/[^\x00-\x7F]/.test(value)) {
						showError("email", "半角英数字で入力してください");
						return;
					}
					
					const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
					if (!emailRegex.test(value)) {
						showError("email", "正しいメールアドレスを入力してください");
					}
				});
			}
			
			// reCAPTCHA読み込み
			const submitBtn = form?.querySelector('button[type="submit"]');
			
			// 初期状態: ボタンを無効化
			if (submitBtn) {
				submitBtn.disabled = true;
				submitBtn.style.opacity = '0.5';
				submitBtn.style.cursor = 'not-allowed';
			}
			
			if (siteKey) {
				const script = document.createElement("script");
				script.src = `https://www.google.com/recaptcha/api.js?render=${siteKey}`;
				script.onload = () => {
					if (typeof grecaptcha !== "undefined") {
						grecaptcha.ready(() => {
							recaptchaReady = true;
							console.log('reCAPTCHA ready');
							
							// ボタンを有効化
							if (submitBtn) {
								submitBtn.disabled = false;
								submitBtn.style.opacity = '1';
								submitBtn.style.cursor = 'pointer';
							}
						});
					}
				};
				script.onerror = () => {
					console.error('reCAPTCHA読み込み失敗');
					if (submitBtn) {
						submitBtn.disabled = false;
						submitBtn.style.opacity = '1';
						submitBtn.style.cursor = 'pointer';
					}
				};
				document.head.appendChild(script);
			} else {
				// siteKeyがない場合もボタンを有効化
				if (submitBtn) {
					submitBtn.disabled = false;
					submitBtn.style.opacity = '1';
					submitBtn.style.cursor = 'pointer';
				}
			}
			
			// フォーム送信
			if (form) {
				form.addEventListener("submit", async (e) => {
					e.preventDefault();
					
					let hasError = false;
					
					// バリデーション
					if (!idNumberInput?.value || idNumberInput.value.length !== 4) {
						showError("id_number", "医籍番号は4桁で入力してください");
						hasError = true;
					}
					
					if (!nameInput?.value.trim()) {
						showError("name", "お名前を入力してください");
						hasError = true;
					}
					
					if (!validateBirthday()) {
						hasError = true;
					}
					
					const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
					if (!emailInput?.value.trim() || !emailRegex.test(emailInput.value)) {
						showError("email", "正しいメールアドレスを入力してください");
						hasError = true;
					}
					
					if (hasError) {
						const firstError = document.querySelector(".c-contact__item-error[style*='display: block']");
						if (firstError) {
							firstError.closest(".c-contact__item").scrollIntoView({ behavior: "smooth", block: "center" });
						}
						return;
					}
					
					// reCAPTCHAトークン取得
					console.log('Submit clicked');
					console.log('recaptchaReady:', recaptchaReady);
					console.log('grecaptcha exists:', typeof grecaptcha !== 'undefined');
					
					if (!recaptchaReady || typeof grecaptcha === 'undefined') {
						console.error('reCAPTCHA not ready');
						// 10秒待ってからリトライを促す
						setTimeout(() => {
							alert('送信準備中です。もう一度お試しください。');
						}, 100);
						return;
					}
					
					try {
						const token = await grecaptcha.execute(siteKey, { action: 'submit' });
						const tokenInput = document.getElementById("g-recaptcha-response");
						if (tokenInput) {
							tokenInput.value = token;
						}
						
						// 送信ボタンを無効化
						const submitBtn = form.querySelector('button[type="submit"]');
						if (submitBtn) {
							submitBtn.disabled = true;
							const arrow = submitBtn.querySelector('.c-contact__submit-arrow');
							if (arrow) arrow.style.display = 'none';
							submitBtn.childNodes[0].textContent = '送信中...';
						}
						
						// フォーム送信
						form.submit();
					} catch (error) {
						console.error('reCAPTCHA error:', error);
						alert('送信に失敗しました。ページを再読み込みしてください。');
					}
				});
			}
		});
	</script>
</Layout>