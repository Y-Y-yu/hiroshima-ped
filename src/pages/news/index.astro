---
import Layout from "../../layouts/Layout.astro";

const title = "お知らせ";
const description = "広島県小児科医会のお知らせ一覧です。";
const url = "https://blog.hiroshima-ped.com/news";
const keywords = "広島県小児科医会, 広島, 広島県, 小児科医会, お知らせ";
---

<Layout title={title} description={description} url={url}>
  <div class="c-subpage__upper">
    <div class="c-subpage__upper-ttl">
      News
    </div>
    <div class="c-subpage__upper-pagination">
      <span><a href="/">トップ</a></span>
      <span></span>
      <span>お知らせ</span>
    </div>
  </div>
  <section class="l-subpage">
    <h1 class="c-subpage__ttl u-font--32">
      ニュース一覧
    </h1>
    <ul class="c-news-all" id="news-list">
      <li style="list-style: none; text-align: center; padding: 40px 0;">読み込み中...</li>
    </ul>
  </section>

  <script>
    const container = document.getElementById('news-list');
    const WP_BASE = 'https://wp.hiroshima-ped.com/wp-json/wp/v2';

    async function loadNews() {
      try {
        const res = await fetch(`${WP_BASE}/posts?per_page=20&_embed`);
        
        if (!res.ok) {
          container.innerHTML = '<li style="list-style: none; text-align: center; padding: 40px 0;">お知らせの取得に失敗しました</li>';
          return;
        }

        const posts = await res.json();

        if (!posts.length) {
          container.innerHTML = '<li style="list-style: none; text-align: center; padding: 40px 0;">お知らせはありません</li>';
          return;
        }

        container.innerHTML = posts.map(post => {
          let imageUrl = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || '';
          
          // 画像URLの修正
          if (imageUrl) {
            if (imageUrl.startsWith('/')) {
              imageUrl = `https://wp.hiroshima-ped.com${imageUrl}`;
            } else if (imageUrl.includes('blog.hiroshima-ped.com')) {
              imageUrl = imageUrl.replace('blog.hiroshima-ped.com', 'wp.hiroshima-ped.com');
            }
          }

          const date = new Date(post.date).toLocaleDateString('ja-JP');

          return `
            <li class="c-news-all__item">
              <a href="/news/${post.id}" style="text-decoration:none; color:#333;">
                <div class="c-news-all__item-img">
                  ${imageUrl ? `<img src="${imageUrl}" alt="${post.title.rendered}">` : ''}
                </div>
                <div class="c-news-all__item-text">
                  <time datetime="${post.date}">${date}</time>
                  <div class="c-news-all__item-ttl">${post.title.rendered}</div>
                </div>
              </a>
            </li>
          `;
        }).join('');

      } catch (err) {
        container.innerHTML = '<li style="list-style: none; text-align: center; padding: 40px 0;">お知らせの取得に失敗しました</li>';
        console.error('Error loading news:', err);
      }
    }

    loadNews();
  </script>
</Layout>