---
import Layout from "../../layouts/Layout.astro";

export const prerender = false; // 修正: false に変更（動的レンダリング）

// =====================
// 型定義
// =====================
type WPPost = {
  id: number;
  slug: string;
  date: string;
  title: { rendered: string };
  content: { rendered: string };
  _embedded?: {
    ["wp:featuredmedia"]?: {
      source_url: string;
    }[];
  };
};

// =====================
// 動的に投稿を取得
// =====================
const { slug } = Astro.params;
const WP_BASE = 'https://wp.hiroshima-ped.com/wp-json/wp/v2';

let post: WPPost | null = null;
let errorMessage = '';

try {
  const apiUrl = `${WP_BASE}/posts/${slug}`;
  console.log('Fetching from:', apiUrl);
  
  const res = await fetch(apiUrl);
  console.log('Response status:', res.status);
  
  if (res.ok) {
    post = await res.json();
    console.log('Post fetched successfully:', post.id);
  } else {
    errorMessage = `API returned ${res.status}: ${res.statusText}`;
    console.error(errorMessage);
  }
} catch (err) {
  errorMessage = `Error: ${err}`;
  console.error("Error fetching post:", err);
}

// =====================
// アイキャッチ取得
// =====================
let imageUrl = post?._embedded?.["wp:featuredmedia"]?.[0]?.source_url ?? "";

// =====================
// ページメタ情報
// =====================
const title = post?.title.rendered ?? "Post";
const description = post?.title.rendered ?? "";
const url = `/news/${slug}`;
---

<Layout title={title} description={description} url={url}>
    <div class="c-subpage__upper">
    <div class="c-subpage__upper-ttl">
      News
    </div>
    <div class="c-subpage__upper-pagination">
      <span><a href="/">トップ</a></span>
      <span></span>
      <span><a href="/news">お知らせ</a></span>
    </div>
  </div>
  <section class="l-subpage">
    {post ? (
      <article class="c-news-single">
        <h1 class="c-subpage__ttl u-font--32" set:html={post.title.rendered}></h1>

        <time datetime={post.date} class="c-blog__date">
          {new Date(post.date).toLocaleDateString("ja-JP")}
        </time>

        {imageUrl && (
          <img
            src={imageUrl}
            alt={post.title.rendered}
            class="c-blog__img"
            loading="lazy"
          />
        )}

        <div
          class="c-blog__content post-content"
          set:html={post.content.rendered}
        ></div>
      </article>
    ) : (
      <div>
        <p>記事が見つかりませんでした。</p>
        {errorMessage && <p style="color: red; margin-top: 10px;">デバッグ情報: {errorMessage}</p>}
        <p style="color: gray; margin-top: 10px;">アクセスしたID: {slug}</p>
      </div>
    )}
  </section>
</Layout>