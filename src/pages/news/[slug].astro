---
import Layout from "../../layouts/Layout.astro";

export const prerender = false;

const { slug } = Astro.params;

const title = "お知らせ";
const description = "広島県小児科医会のお知らせ";
const url = `/news/${slug}`;
---

<Layout title={title} description={description} url={url}>
  <div class="c-subpage__upper">
    <div class="c-subpage__upper-ttl">
      News
    </div>
    <div class="c-subpage__upper-pagination">
      <span><a href="/">トップ</a></span>
      <span></span>
      <span><a href="/news">お知らせ</a></span>
    </div>
  </div>
  
  <section class="l-subpage">
    <div id="post-container">
      <p>読み込み中...</p>
    </div>
  </section>

  <script define:vars={{ slug }}>
    const container = document.getElementById('post-container');
    const WP_BASE = 'https://wp.hiroshima-ped.com/wp-json/wp/v2';

    async function loadPost() {
      try {
        const res = await fetch(`${WP_BASE}/posts/${slug}?_embed`);
        
        if (!res.ok) {
          container.innerHTML = `<p>記事が見つかりませんでした。(エラー: ${res.status})</p>`;
          return;
        }

        const post = await res.json();
        
        let imageUrl = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || '';
        
        // 画像URLが相対パスまたはblog.hiroshima-ped.comの場合、wp.hiroshima-ped.comに変換
        if (imageUrl) {
          if (imageUrl.startsWith('/')) {
            imageUrl = `https://wp.hiroshima-ped.com${imageUrl}`;
          } else if (imageUrl.includes('blog.hiroshima-ped.com')) {
            imageUrl = imageUrl.replace('blog.hiroshima-ped.com', 'wp.hiroshima-ped.com');
          }
        }
        
        const date = new Date(post.date).toLocaleDateString('ja-JP');
        
        container.innerHTML = `
          <article class="c-news-single">
            <h1 class="c-subpage__ttl u-font--32">${post.title.rendered}</h1>
            <time datetime="${post.date}" class="c-blog__date">${date}</time>
            ${imageUrl ? `<img src="${imageUrl}" alt="${post.title.rendered}" class="c-blog__img" loading="lazy">` : ''}
            <div class="c-blog__content post-content">${post.content.rendered}</div>
          </article>
        `;
      } catch (err) {
        container.innerHTML = '<p>記事の取得に失敗しました。</p>';
        console.error('Error loading post:', err);
      }
    }

    loadPost();
  </script>
</Layout>